<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Live</title>
  </head>
  <body>
    <h1>live</h1>

    <script src="reconnecting-ws.js"></script>
    <script src="store.js"></script>

    <script src="d3.min.js"></script>
    <script type="text/javascript">
      var ul = d3.select('body').append('ul')

      store.listen( () => {
        var li = ul.selectAll('li').data(
          Object.keys(store.data)
        )

        li.enter()
          .append('li')

        li.exit()
          .remove()

        li
          .text(d => d + " -> " +JSON.stringify(store.data[d][0].data.status))

      })


    var ws = new WebSocket(location.origin.replace(/^http/, 'ws') + '/sample')
    ws.binaryType = 'arraybuffer'

    var AudioContext = window.AudioContext || window.webkitAudioContext;
    var context = new AudioContext();

    var time = 2

    var buffers = []
    ws.onmessage = function(e){

      var input = new Int16Array(e.data)
      var buffer = context.createBuffer(1, input.length, 16000)
      var data = buffer.getChannelData(0)
      for (var i = 0; i < data.length; i++) {
        data[i] = input[i] / 32767
      }

      var source = context.createBufferSource()
      source.buffer = buffer
      source.connect(context.destination)
      source.start(time += buffer.duration)

    }




    </script>
  </body>
</html>
