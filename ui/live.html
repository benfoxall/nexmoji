<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Live</title>
  </head>
  <body>
    <h1>live</h1>

    <script src="reconnecting-ws.js"></script>
    <script src="store.js"></script>

    <script src="d3.min.js"></script>
    <script type="text/javascript">
      var ul = d3.select('body').append('ul')

      store.listen( () => {
        var li = ul.selectAll('li').data(
          Object.keys(store.data)
        )

        li.enter()
          .append('li')

        li.exit()
          .remove()

        li
          .text(d => d + " -> " +JSON.stringify(store.data[d][0].data.status))

      })


    var ws = new WebSocket(location.origin.replace(/^http/, 'ws') + '/sample')

    ws.binaryType = 'arraybuffer'


    var chunkToWAV = (function(chunkSize){

      var head = atob(
        'UklGRiQAAABXQVZFZm10IBAAAAABAAEAgD4AAAB9AAACABAAZGF0YQAAAAA='
      )

      var buffer = new ArrayBuffer(head.length + chunkSize)
      var view = new DataView(buffer)

      for (var i = 0; i < head.length; i++) {
        view.setUint8(i, head.charCodeAt(i))
      }

      var dataArray = new Int16Array(buffer)
      return function toWAV(chunk) {
        dataArray.set(new Int16Array(chunk), 22)
        return buffer
      }

    })(640)


    var AudioContext = window.AudioContext || window.webkitAudioContext;
    var context = new AudioContext();

    var time = 0
    ws.onmessage = function(e){

      var wav = chunkToWAV(e.data)

      context.decodeAudioData(wav, function(buffer) {
        var source = context.createBufferSource()

        source.buffer = buffer

        source.start(time += buffer.duration)

        source.connect(context.destination)

	    })

    }




    </script>
  </body>
</html>
